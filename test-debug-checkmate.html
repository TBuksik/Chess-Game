<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Checkmate Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Debug Checkmate Test</h1>
    <div id="debug-output"></div>
    
    <script>
        function debugCheckmate() {
            const output = document.getElementById('debug-output');
            
            function log(message) {
                const div = document.createElement('div');
                div.className = 'debug-info';
                div.textContent = message;
                output.appendChild(div);
                console.log(message);
            }
            
            log('Starting checkmate debug test...');
            
            // Test the actual checkmate scenario from the original test
            const board = Array(8).fill().map(() => Array(8).fill(null));
            
            // Set up pieces
            const blackKing = { type: 'king', color: 'black', row: 0, col: 4 };
            const whiteQueen = { type: 'queen', color: 'white', row: 1, col: 3 };
            const whiteKing = { type: 'king', color: 'white', row: 7, col: 4 };
            
            board[0][4] = blackKing;
            board[1][3] = whiteQueen;
            board[7][4] = whiteKing;
            
            log('Board setup complete');
            log(`Black king at (0,4), White queen at (1,3), White king at (7,4)`);
            
            // Test king moves
            function getKingMoves(king, board) {
                const moves = [];
                const directions = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1],           [0, 1],
                    [1, -1],  [1, 0],  [1, 1]
                ];
                
                for (let [rowOffset, colOffset] of directions) {
                    const newRow = king.row + rowOffset;
                    const newCol = king.col + colOffset;
                    
                    if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                        const target = board[newRow][newCol];
                        if (!target || target.color !== king.color) {
                            moves.push([newRow, newCol]);
                        }
                    }
                }
                return moves;
            }
            
            // Test queen moves
            function getQueenMoves(queen, board) {
                const moves = [];
                const directions = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1],           [0, 1],
                    [1, -1],  [1, 0],  [1, 1]
                ];
                
                for (let [rowDir, colDir] of directions) {
                    for (let i = 1; i < 8; i++) {
                        const newRow = queen.row + rowDir * i;
                        const newCol = queen.col + colDir * i;
                        
                        if (newRow < 0 || newRow >= 8 || newCol < 0 || newCol >= 8) break;
                        
                        const target = board[newRow][newCol];
                        if (!target) {
                            moves.push([newRow, newCol]);
                        } else {
                            if (target.color !== queen.color) {
                                moves.push([newRow, newCol]);
                            }
                            break;
                        }
                    }
                }
                return moves;
            }
            
            const kingMoves = getKingMoves(blackKing, board);
            const queenMoves = getQueenMoves(whiteQueen, board);
            
            log(`Black king possible moves: ${JSON.stringify(kingMoves)}`);
            log(`White queen possible moves: ${JSON.stringify(queenMoves)}`);
            
            // Check if queen can attack king
            const queenAttacksKing = queenMoves.some(([r, c]) => r === blackKing.row && c === blackKing.col);
            log(`Queen attacks king: ${queenAttacksKing}`);
            
            // Check each king move to see if it's safe
            let safeKingMoves = 0;
            for (let [toRow, toCol] of kingMoves) {
                // Simulate the move
                const testBoard = board.map(row => [...row]);
                testBoard[blackKing.row][blackKing.col] = null;
                testBoard[toRow][toCol] = { ...blackKing, row: toRow, col: toCol };
                
                // Check if queen can still attack
                const queenMovesAfter = getQueenMoves(whiteQueen, testBoard);
                const stillAttacked = queenMovesAfter.some(([r, c]) => r === toRow && c === toCol);
                
                log(`King move to (${toRow},${toCol}): still attacked = ${stillAttacked}`);
                
                if (!stillAttacked) {
                    safeKingMoves++;
                }
            }
            
            log(`Safe king moves: ${safeKingMoves}`);
            log(`Is checkmate: ${queenAttacksKing && safeKingMoves === 0}`);
            
            // This should NOT be checkmate because the king has escape squares
            const expectedCheckmate = false;
            const actualCheckmate = queenAttacksKing && safeKingMoves === 0;
            
            log(`Expected checkmate: ${expectedCheckmate}, Actual: ${actualCheckmate}`);
            log(`Test result: ${expectedCheckmate === actualCheckmate ? 'PASS' : 'FAIL'}`);
        }
        
        // Run debug test
        window.onload = debugCheckmate;
    </script>
</body>
</html>
